<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>2025 大阪京都秋旅</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-red': '#B91C1C',    /* 楓葉紅 */
                        'brand-orange': '#C2410C', /* 柿子橘 */
                        'brand-gold': '#D97706',   /* 銀杏黃 */
                        'bg-paper': '#FDFBF7',     /* 和紙白 */
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                        mono: ['Roboto Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #FDFBF7; -webkit-tap-highlight-color: transparent; }
        
        /* 手機安全區域適配 */
        .safe-bottom { padding-bottom: calc(5rem + env(safe-area-inset-bottom)); }
        
        /* Banner 優化 */
        .banner-mask { height: 300px; clip-path: ellipse(160% 100% at 50% 0%); overflow: hidden; position: relative; background-color: #2c2c2c; }
        .banner-img { width: 100%; height: 100%; object-fit: cover; opacity: 0.85; animation: zoomIn 20s infinite alternate; }
        @keyframes zoomIn { from { transform: scale(1); } to { transform: scale(1.1); } }
        
        /* 時間軸線條 */
        .timeline-line { position: absolute; left: 24px; top: 30px; bottom: -30px; width: 2px; background: #e5e7eb; z-index: 0; }
        .last-item .timeline-line { display: none; }

        /* 元件樣式 */
        .active-day { background: linear-gradient(135deg, #B91C1C, #C2410C) !important; color: white !important; box-shadow: 0 8px 16px rgba(185, 28, 28, 0.3); transform: translateY(-2px); }
        .glass-panel { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.5); }
        .btn-press { transition: all 0.15s ease; cursor: pointer; }
        .btn-press:active { transform: scale(0.92); }
        .action-btn { z-index: 50; position: relative; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .text-shadow { text-shadow: 0 2px 8px rgba(0,0,0,0.5); }
        
        /* 輸入框優化 */
        input, textarea, select { -webkit-appearance: none; appearance: none; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #C2410C; ring: 2px solid #fed7aa; }
        
        [v-cloak] { display: none; }
        
        /* Modal Transition */
        .modal-enter-active, .modal-leave-active { transition: opacity 0.2s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }
        .modal-enter-active .modal-card, .modal-leave-active .modal-card { transition: transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .modal-enter-from .modal-card, .modal-leave-to .modal-card { transform: scale(0.9) translateY(30px); }
    </style>
</head>
<body class="text-gray-700">

<div id="app" v-cloak>
    <div class="banner-mask">
        <img src="banner.png" class="banner-img" alt="Osaka Kyoto" onerror="this.src='https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?auto=format&fit=crop&w=1000&q=80'">
        
        <div class="absolute top-10 left-6 z-20">
            <p class="text-white/80 text-xs font-bold tracking-[0.3em] mb-1 text-shadow">KYOTO & OSAKA</p>
            <h1 class="text-white font-black text-4xl leading-tight text-shadow tracking-wide">
                2025<br>秋色漫旅
            </h1>
        </div>

        <div class="absolute bottom-16 left-0 right-0 flex justify-center gap-4 z-30 px-4">
            <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id"
                :class="['h-12 px-5 rounded-2xl flex items-center justify-center gap-2 shadow-lg transition-all backdrop-blur-md border border-white/20 action-btn font-bold text-sm', 
                currentTab === tab.id ? 'bg-white/90 text-brand-red scale-105' : 'bg-black/30 text-white hover:bg-black/40']">
                <i :class="tab.icon"></i>
                <span v-if="currentTab === tab.id">{{ tab.name }}</span>
            </button>
        </div>
    </div>

    <main class="main-container px-4 -mt-8 relative z-40 safe-bottom">
        
        <div v-if="currentTab === 'plan'" class="space-y-6">
            
            <div class="flex overflow-x-auto gap-3 pb-4 pt-2 no-scrollbar px-1">
                <button v-for="(day, index) in schedule" :key="index" @click="activeDay = index"
                    :class="['flex-shrink-0 w-14 h-20 rounded-2xl flex flex-col items-center justify-center transition-all bg-white shadow-sm border border-gray-100 action-btn', activeDay === index ? 'active-day' : 'text-gray-400']">
                    <span class="text-[10px] font-bold uppercase mb-1 opacity-80">{{ day.week }}</span>
                    <span class="text-xl font-black font-mono">{{ day.date }}</span>
                </button>
            </div>

            <div class="glass-panel p-4 rounded-3xl shadow-sm relative overflow-hidden">
                <div class="absolute top-0 left-0 w-1 h-full bg-brand-orange"></div>
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-xs font-bold text-brand-orange uppercase tracking-wider"><i class="fa-regular fa-note-sticky mr-1"></i> DAILY MEMO</h3>
                    <button @click="editDayNote" class="text-gray-300 hover:text-brand-orange action-btn"><i class="fa-solid fa-pen"></i></button>
                </div>
                <div v-if="isEditingNote">
                    <textarea v-model="schedule[activeDay].note" class="w-full bg-gray-50 rounded-xl p-2 text-sm text-gray-600 h-20 border-0" placeholder="寫下天氣、穿著或提醒..."></textarea>
                    <button @click="isEditingNote = false" class="text-xs bg-brand-orange text-white px-3 py-1 rounded-full mt-2 action-btn">完成</button>
                </div>
                <p v-else class="text-sm text-gray-600 leading-relaxed min-h-[1.5rem]" @click="editDayNote">
                    {{ schedule[activeDay].note || '點擊此處新增今日筆記 (如: 天氣 15度、穿和服)...' }}
                </p>
            </div>

            <div class="space-y-0">
                <div v-for="(item, idx) in schedule[activeDay].items" :key="idx" class="relative pl-8 pb-8 group" :class="{'last-item': idx === schedule[activeDay].items.length - 1}">
                    <div class="timeline-line"></div>
                    
                    <div class="absolute left-[14px] top-6 w-5 h-5 rounded-full bg-white border-[3px] border-brand-red z-10 shadow-sm flex items-center justify-center text-[8px] font-bold text-brand-red">
                        {{ idx + 1 }}
                    </div>

                    <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-50 relative overflow-hidden transition-all hover:shadow-md btn-press" @click="openEditModal(idx)">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <span class="text-[10px] font-bold text-white bg-brand-red px-2 py-0.5 rounded-full mb-2 inline-block shadow-sm">{{ item.tag }}</span>
                                <h3 class="font-bold text-lg text-gray-800 leading-tight">{{ item.title }}</h3>
                            </div>
                            
                            <a :href="getSmartMapUrl(item)" target="_blank" @click.stop class="w-10 h-10 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center shadow-sm hover:bg-blue-600 hover:text-white transition-colors action-btn" title="Google 導航">
                                <i class="fa-solid fa-location-arrow text-sm"></i>
                            </a>
                        </div>
                        
                        <div class="flex items-center gap-2 text-sm text-gray-500 font-bold mb-3">
                            <i class="fa-regular fa-clock text-brand-orange"></i> {{ item.time }}
                            <span v-if="item.transport" class="text-[10px] bg-gray-100 px-2 py-0.5 rounded text-gray-400 font-normal ml-2">
                                <i :class="getTransportIcon(item.transportType)"></i> {{ item.transport }}
                            </span>
                        </div>
                        
                        <p v-if="item.desc" class="text-sm text-gray-600 bg-bg-paper p-3 rounded-xl leading-relaxed whitespace-pre-line border border-gray-100">{{ item.desc }}</p>

                        <button @click.stop="deleteScheduleItem(idx)" class="absolute bottom-2 right-2 w-8 h-8 text-gray-300 hover:text-red-500 action-btn opacity-0 group-hover:opacity-100 transition-opacity">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </div>
                </div>
                
                <div class="h-20"></div>
                <button @click="openAddModal" class="fixed bottom-6 right-6 w-14 h-14 bg-gray-900 text-white rounded-full shadow-2xl flex items-center justify-center text-2xl z-50 btn-press action-btn border-2 border-white/20">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>
        </div>

        <div v-if="currentTab === 'wallet'" class="space-y-6">
            <h2 class="text-2xl font-black text-gray-800 ml-1">旅行錢包</h2>

            <div class="bg-gray-900 text-white p-6 rounded-3xl shadow-xl relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-brand-orange rounded-full mix-blend-overlay filter blur-3xl opacity-20"></div>
                
                <div class="flex justify-between items-end mb-2">
                    <span class="text-xs font-bold text-gray-400 tracking-widest">TOTAL SPENT</span>
                    <button @click="setBudget" class="text-xs bg-white/10 px-2 py-1 rounded hover:bg-white/20 action-btn">設定預算</button>
                </div>
                
                <div class="flex items-baseline gap-1 mb-4">
                    <span class="text-xl">¥</span>
                    <span class="text-5xl font-black tracking-tight">{{ totalExpense.toLocaleString() }}</span>
                </div>

                <div v-if="budget > 0">
                    <div class="flex justify-between text-[10px] font-bold mb-1 opacity-70">
                        <span>預算: ¥{{ budget.toLocaleString() }}</span>
                        <span>剩餘: ¥{{ (budget - totalExpense).toLocaleString() }}</span>
                    </div>
                    <div class="w-full h-2 bg-gray-700 rounded-full overflow-hidden">
                        <div class="h-full transition-all duration-1000 ease-out" 
                             :style="{ width: Math.min((totalExpense/budget)*100, 100) + '%', backgroundColor: getBudgetColor() }"></div>
                    </div>
                </div>
                <div v-else class="text-xs text-gray-500">點擊上方按鈕設定總預算</div>
            </div>

            <div class="glass-panel p-2 rounded-2xl flex gap-2">
                <input v-model="newExpenseName" placeholder="項目 (如: 章魚燒)" class="flex-[2] bg-transparent px-3 py-2 text-sm font-bold text-gray-700 placeholder-gray-400">
                <input v-model="newExpensePrice" type="number" placeholder="¥ 金額" class="flex-1 bg-white/50 rounded-xl px-3 py-2 text-sm font-bold text-center">
                <button @click="addExpense" class="w-10 h-10 bg-brand-orange text-white rounded-xl flex items-center justify-center shadow-lg btn-press action-btn">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <div class="space-y-3 pb-20">
                <div v-for="(ex, idx) in expenses" :key="idx" class="flex justify-between items-center p-4 bg-white rounded-2xl shadow-sm border border-gray-50">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-orange-50 flex items-center justify-center text-brand-orange text-xs">
                            <i class="fa-solid fa-tag"></i>
                        </div>
                        <span class="font-bold text-gray-700">{{ ex.name }}</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-black text-gray-800">¥{{ parseInt(ex.price).toLocaleString() }}</span>
                        <button @click="removeExpense(idx)" class="text-gray-300 hover:text-red-500 action-btn px-2"><i class="fa-solid fa-times"></i></button>
                    </div>
                </div>
                <div v-if="expenses.length === 0" class="text-center py-10 text-gray-300">
                    <i class="fa-solid fa-receipt text-4xl mb-2 opacity-30"></i>
                    <p class="text-sm">尚無消費紀錄</p>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'checklist'" class="space-y-6">
            <h2 class="text-2xl font-black text-gray-800 ml-1">必備物品</h2>
            
            <div class="glass-panel p-2 rounded-2xl flex gap-2 mb-4">
                <input v-model="newCheckItem" placeholder="新增物品 (如: 變壓器)" class="flex-1 bg-transparent px-3 py-2 text-sm font-bold" @keyup.enter="addCheckItem">
                <button @click="addCheckItem" class="w-10 h-10 bg-brand-red text-white rounded-xl flex items-center justify-center shadow-lg btn-press action-btn">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <div class="grid grid-cols-1 gap-3 pb-20">
                <div v-for="(item, idx) in packingList" :key="idx" 
                     class="flex items-center justify-between p-4 bg-white rounded-2xl border transition-all btn-press"
                     :class="item.done ? 'border-green-100 bg-green-50/30' : 'border-gray-100 shadow-sm'"
                     @click="item.done = !item.done">
                    <div class="flex items-center gap-4">
                        <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors"
                             :class="item.done ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300'">
                            <i v-if="item.done" class="fa-solid fa-check text-xs"></i>
                        </div>
                        <span :class="['font-bold', item.done ? 'text-gray-400 line-through' : 'text-gray-700']">{{ item.name }}</span>
                    </div>
                    <button @click.stop="removeCheckItem(idx)" class="text-gray-300 hover:text-red-500 action-btn px-2"><i class="fa-solid fa-trash"></i></button>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'info'" class="space-y-6 pb-20">
            <h2 class="text-2xl font-black text-gray-800 ml-1">旅程資訊</h2>

            <div class="bg-red-50 border border-red-100 p-5 rounded-2xl">
                <h3 class="text-red-800 font-bold text-sm mb-3 flex items-center gap-2"><i class="fa-solid fa-triangle-exclamation"></i> 緊急聯絡</h3>
                <div class="space-y-2 text-sm text-gray-600">
                    <div class="flex justify-between"><span>警察局</span><span class="font-mono font-bold">110</span></div>
                    <div class="flex justify-between"><span>救護車/火警</span><span class="font-mono font-bold">119</span></div>
                    <div class="flex justify-between"><span>台北駐大阪辦事處</span><span class="font-mono font-bold text-blue-600"><a href="tel:+81-6-6227-8623">+81-6-6227-8623</a></span></div>
                </div>
            </div>

            <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-gray-400 text-xs uppercase mb-4 tracking-widest">HOTELS</h3>
                <div class="space-y-4">
                    <div v-for="h in hotels" class="border-l-4 border-gray-200 pl-4 py-1">
                        <span class="text-[10px] bg-gray-100 px-2 py-0.5 rounded text-gray-500 font-bold">{{ h.date }}</span>
                        <p class="font-bold text-gray-800 mt-1">{{ h.name }}</p>
                        <a :href="getSmartMapUrl({title: h.name, mapUrl: h.mapUrl})" target="_blank" class="text-xs text-blue-500 mt-1 inline-flex items-center gap-1 font-bold hover:underline action-btn">
                            <i class="fa-solid fa-map-location-dot"></i> 導航前往
                        </a>
                    </div>
                </div>
            </div>

            <div class="bg-gray-800 text-white p-5 rounded-3xl shadow-lg">
                <h3 class="font-bold text-xs uppercase mb-4 tracking-widest text-gray-400">DATA BACKUP</h3>
                <div class="flex gap-3">
                    <button @click="exportData" class="flex-1 bg-white/10 hover:bg-white/20 py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 action-btn">
                        <i class="fa-solid fa-download"></i> 匯出備份
                    </button>
                    <button @click="triggerImport" class="flex-1 bg-white/10 hover:bg-white/20 py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 action-btn">
                        <i class="fa-solid fa-upload"></i> 匯入還原
                    </button>
                    <input type="file" ref="fileInput" class="hidden" @change="importData" accept=".json">
                </div>
                <div class="mt-4 pt-4 border-t border-white/10 text-center">
                    <button @click="resetData" class="text-[10px] text-red-300 hover:text-white action-btn">清除所有資料並重置</button>
                </div>
            </div>
        </div>
    </main>

    <transition name="modal">
        <div v-if="showModal" class="fixed inset-0 z-[100] flex items-end sm:items-center justify-center pointer-events-none">
            <div class="absolute inset-0 bg-black/30 backdrop-blur-sm pointer-events-auto" @click="closeModal"></div>
            <div class="modal-card bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl relative z-10 pointer-events-auto pb-10 sm:pb-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-black text-gray-800">{{ isEditing ? '編輯行程' : '新增行程' }}</h3>
                    <button @click="closeModal" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500 action-btn"><i class="fa-solid fa-xmark"></i></button>
                </div>
                
                <div class="space-y-4 max-h-[60vh] overflow-y-auto px-1">
                    <div>
                        <label class="text-xs font-bold text-gray-400 uppercase ml-1">標題</label>
                        <input v-model="tempItem.title" placeholder="例如：清水寺、吃拉麵" class="w-full bg-gray-50 p-4 rounded-2xl font-bold text-lg border border-transparent focus:bg-white focus:border-brand-orange transition-colors">
                    </div>
                    
                    <div>
                        <label class="text-xs font-bold text-gray-400 uppercase ml-1">地圖設定</label>
                        <input v-model="tempItem.mapUrl" placeholder="留空則自動搜尋標題，或貼上網址" class="w-full bg-gray-50 p-3 rounded-xl text-sm border border-transparent focus:bg-white focus:border-brand-orange">
                        <p class="text-[10px] text-gray-400 mt-1 ml-1">* 系統會自動產生 Google Maps 連結</p>
                    </div>

                    <div class="flex gap-3">
                        <div class="flex-1">
                            <label class="text-xs font-bold text-gray-400 uppercase ml-1">時間</label>
                            <input v-model="tempItem.time" type="time" class="w-full bg-gray-50 p-3 rounded-xl font-mono text-sm border border-transparent focus:bg-white focus:border-brand-orange">
                        </div>
                        <div class="flex-1">
                            <label class="text-xs font-bold text-gray-400 uppercase ml-1">分類</label>
                            <select v-model="tempItem.tag" class="w-full bg-gray-50 p-3 rounded-xl text-sm border border-transparent focus:bg-white focus:border-brand-orange">
                                <option>景點</option><option>美食</option><option>購物</option>
                                <option>交通</option><option>住宿</option><option>攝影</option><option>自訂</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-gray-400 uppercase ml-1">備註</label>
                        <textarea v-model="tempItem.desc" rows="3" placeholder="輸入詳細資訊、預約代號等..." class="w-full bg-gray-50 p-3 rounded-xl text-sm border border-transparent focus:bg-white focus:border-brand-orange resize-none"></textarea>
                    </div>
                </div>

                <button @click="saveSchedule" class="w-full bg-black text-white font-bold py-4 rounded-2xl mt-6 shadow-xl btn-press action-btn text-lg">
                    {{ isEditing ? '儲存變更' : '確認新增' }}
                </button>
            </div>
        </div>
    </transition>
</div>

<script>
    const { createApp, ref, computed, watch, onMounted } = Vue;

    createApp({
        setup() {
            const currentTab = ref('plan');
            const activeDay = ref(0);
            const fileInput = ref(null);
            
            // UI States
            const showModal = ref(false);
            const isEditing = ref(false);
            const editingIndex = ref(-1);
            const isEditingNote = ref(false);
            const tempItem = ref({ title: '', time: '', tag: '自訂', desc: '', mapUrl: '' });

            // Data States
            const budget = ref(0); // 總預算
            const packingList = ref([
                { name: '護照', done: false }, { name: '日幣現金', done: false }, { name: '信用卡', done: false },
                { name: 'SIM卡 / 漫遊', done: false }, { name: '行動電源', done: false }, { name: '個人藥品', done: false }
            ]);
            const expenses = ref([]);
            
            // 預設行程 (含每日筆記欄位 note)
            const defaultSchedule = [
                { week: 'Sun', date: '12/01', note: '', items: [{ tag: '航班', title: '抵達大阪 (KIX)', time: '10:55', desc: 'BR182', transport: 'plane', transportType: 'plane' }, { tag: '交通', title: '前往京都', time: '13:00', desc: 'Haruka', transport: '1.5hr', transportType: 'train' }, { tag: '住宿', title: 'HOTEL TAVINOS KYOTO', time: '15:00', desc: 'Check-in', mapUrl: '' }, { tag: '美食', title: '大力邸', time: '16:00', desc: '南禪寺附近晚餐', mapUrl: '' }] },
                { week: 'Mon', date: '12/02', note: '', items: [{ tag: '場勘', title: '京都巡禮', time: '09:00', desc: '鴨川 -> 花見小路 -> 八阪神社', mapUrl: '' }] },
                { week: 'Tue', date: '12/03', note: '', items: [{ tag: '攝影', title: '全家福拍攝', time: '08:00', desc: '筱芷全家福', mapUrl: '' }] },
                { week: 'Wed', date: '12/04', note: '', items: [{ tag: '婚紗', title: '南禪寺拍攝', time: '08:40', desc: '白紗', transport: 'Uber', transportType: 'car' }, { tag: '婚紗', title: '二三年阪拍攝', time: '12:30', desc: '和服', mapUrl: '' }] },
                { week: 'Thu', date: '12/05', note: '', items: [{ tag: '婚紗', title: '真如堂拍攝', time: '12:00', desc: '黑紗', transport: 'Uber', transportType: 'car' }] },
                { week: 'Fri', date: '12/06', note: '', items: [{ tag: '交通', title: '前往天橋立', time: '12:25', desc: 'JR + 丹後鐵道', transport: 'Train', transportType: 'train' }, { tag: '景點', title: '天橋立沙洲', time: '15:30', desc: '散步', mapUrl: '' }, { tag: '美食', title: '富田屋', time: '18:00', desc: '海鮮晚餐', mapUrl: '' }] },
                { week: 'Sat', date: '12/07', note: '', items: [{ tag: '景點', title: '伊根舟屋', time: '14:00', desc: '搭巴士前往', transport: 'Bus', transportType: 'bus' }] },
                { week: 'Sun', date: '12/08', note: '', items: [{ tag: '交通', title: '前往大阪', time: '11:55', desc: '回到大阪市區', transport: 'Train', transportType: 'train' }, { tag: '住宿', title: '大阪東急卓越', time: '15:00', desc: 'Check-in' }] },
                { week: 'Mon', date: '12/09', note: '', items: [{ tag: '景點', title: '環球影城 USJ', time: '08:30', desc: 'VIP 導覽', transport: 'Train', transportType: 'train' }] },
                { week: 'Tue', date: '12/10', note: '', items: [{ tag: '景點', title: '通天閣', time: '10:00', desc: '溜滑梯', mapUrl: '' }, { tag: '美食', title: '浪芳庵', time: '16:00', desc: '日式點心', mapUrl: '' }] },
                { week: 'Wed', date: '12/11', note: '', items: [{ tag: '交通', title: '前往機場', time: '07:00', desc: '專車接送', transport: 'Car', transportType: 'car' }, { tag: '航班', title: '返回高雄', time: '11:55', desc: 'BR181', transport: 'plane', transportType: 'plane' }] }
            ];

            const schedule = ref(JSON.parse(JSON.stringify(defaultSchedule)));

            // Smart Map URL Generator (關鍵修正：自動產生連結)
            const getSmartMapUrl = (item) => {
                if (item.mapUrl && item.mapUrl.trim() !== '') return item.mapUrl; // 如果有手填網址，優先使用
                // 否則自動產生搜尋連結
                return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.title)}`;
            };

            // Local Storage Persistence
            onMounted(() => {
                const savedSch = localStorage.getItem('trip_v4_sch');
                if (savedSch) schedule.value = JSON.parse(savedSch);
                
                const savedList = localStorage.getItem('trip_v4_list');
                if (savedList) packingList.value = JSON.parse(savedList);
                
                const savedExp = localStorage.getItem('trip_v4_exp');
                if (savedExp) expenses.value = JSON.parse(savedExp);
                
                const savedBud = localStorage.getItem('trip_v4_bud');
                if (savedBud) budget.value = parseInt(savedBud);
            });

            // Watchers for Auto-Save
            watch(schedule, v => localStorage.setItem('trip_v4_sch', JSON.stringify(v)), { deep: true });
            watch(packingList, v => localStorage.setItem('trip_v4_list', JSON.stringify(v)), { deep: true });
            watch(expenses, v => localStorage.setItem('trip_v4_exp', JSON.stringify(v)), { deep: true });
            watch(budget, v => localStorage.setItem('trip_v4_bud', v));

            // Budget Logic
            const totalExpense = computed(() => expenses.value.reduce((acc, cur) => acc + parseInt(cur.price || 0), 0));
            const getBudgetColor = () => {
                const p = (totalExpense.value / budget.value) * 100;
                if (p > 90) return '#EF4444'; // Red
                if (p > 70) return '#F59E0B'; // Orange
                return '#10B981'; // Green
            };
            const setBudget = () => {
                const val = prompt('請輸入總預算 (日幣):', budget.value);
                if(val) budget.value = parseInt(val);
            };

            // Expense Logic
            const newExpenseName = ref('');
            const newExpensePrice = ref('');
            const addExpense = () => {
                if(newExpenseName.value && newExpensePrice.value) {
                    expenses.value.unshift({ name: newExpenseName.value, price: newExpensePrice.value });
                    newExpenseName.value = ''; newExpensePrice.value = '';
                }
            };
            const removeExpense = (idx) => expenses.value.splice(idx, 1);

            // Checklist Logic
            const newCheckItem = ref('');
            const addCheckItem = () => {
                if(newCheckItem.value.trim()) {
                    packingList.value.push({ name: newCheckItem.value, done: false });
                    newCheckItem.value = '';
                }
            };
            const removeCheckItem = (idx) => packingList.value.splice(idx, 1);

            // Schedule Editing Logic
            const openAddModal = () => {
                isEditing.value = false;
                tempItem.value = { title: '', time: '', tag: '自訂', desc: '', mapUrl: '' };
                showModal.value = true;
            };
            const openEditModal = (idx) => {
                isEditing.value = true;
                editingIndex.value = idx;
                tempItem.value = { ...schedule.value[activeDay.value].items[idx] };
                showModal.value = true;
            };
            const closeModal = () => showModal.value = false;
            const saveSchedule = () => {
                if (!tempItem.value.title) return;
                const itemData = { ...tempItem.value, time: tempItem.value.time || '待定' };
                if (isEditing.value) {
                    schedule.value[activeDay.value].items[editingIndex.value] = itemData;
                } else {
                    schedule.value[activeDay.value].items.push(itemData);
                }
                closeModal();
            };
            const deleteScheduleItem = (idx) => {
                if (confirm('確定要刪除嗎？')) schedule.value[activeDay.value].items.splice(idx, 1);
            };
            const editDayNote = () => isEditingNote.value = true;

            // Import/Export
            const exportData = () => {
                const data = { schedule: schedule.value, packingList: packingList.value, expenses: expenses.value, budget: budget.value };
                const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `KyotoTrip_Backup_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
            };
            const triggerImport = () => fileInput.value.click();
            const importData = (e) => {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const data = JSON.parse(evt.target.result);
                        if(data.schedule) schedule.value = data.schedule;
                        if(data.packingList) packingList.value = data.packingList;
                        if(data.expenses) expenses.value = data.expenses;
                        if(data.budget) budget.value = data.budget;
                        alert('還原成功！');
                    } catch(err) { alert('檔案錯誤'); }
                };
                reader.readAsText(e.target.files[0]);
            };
            const resetData = () => {
                if(confirm('警告：這將清除所有您的編輯紀錄，回復到原始設定。確定嗎？')) {
                    localStorage.clear();
                    location.reload();
                }
            };

            const tabs = [
                { id: 'plan', name: '行程', icon: 'fa-solid fa-map' },
                { id: 'checklist', name: '清單', icon: 'fa-solid fa-clipboard-check' },
                { id: 'wallet', name: '錢包', icon: 'fa-solid fa-wallet' },
                { id: 'info', name: '資訊', icon: 'fa-solid fa-circle-info' }
            ];
            
            const hotels = [
                { date: '12/1-12/5', name: 'HOTEL TAVINOS KYOTO', mapUrl: '' },
                { date: '12/6-12/7', name: 'Fairfield by Marriott Amanohashidate', mapUrl: '' },
                { date: '12/8-12/10', name: '大阪東急卓越大酒店', mapUrl: '' }
            ];

            const getTransportIcon = (t) => ({ plane: 'fa-solid fa-plane', train: 'fa-solid fa-train-subway', bus: 'fa-solid fa-bus', car: 'fa-solid fa-car', walk: 'fa-solid fa-person-walking' }[t] || 'fa-solid fa-location-arrow');

            return { 
                currentTab, activeDay, schedule, budget, packingList, expenses, 
                showModal, isEditing, tempItem, isEditingNote, fileInput,
                totalExpense, getBudgetColor, setBudget, addExpense, removeExpense, 
                newExpenseName, newExpensePrice, newCheckItem, addCheckItem, removeCheckItem,
                openAddModal, openEditModal, closeModal, saveSchedule, deleteScheduleItem, editDayNote,
                exportData, triggerImport, importData, resetData, getSmartMapUrl, tabs, hotels, getTransportIcon
            };
        }
    }).mount('#app');
</script>
</body>
</html>
