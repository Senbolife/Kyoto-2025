<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>2025 大阪自由行 | Kyoto & Osaka</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Zen+Old+Mincho:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'akane': '#B7282E',
                        'sumi': '#2C2C2C',
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                        serif: ['Zen Old Mincho', 'serif'],
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.07)',
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            color: #2C2C2C;
            -webkit-tap-highlight-color: transparent; 
            background-color: #FDFBF7;
            overflow-x: hidden;
        }

        /* === 動態流光背景 (高級感的核心) === */
        .ambient-bg {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: -1;
            background: radial-gradient(circle at 0% 0%, #fdfbf7 50%, #fce7e7 100%);
            overflow: hidden;
        }
        .blob {
            position: absolute;
            filter: blur(80px);
            opacity: 0.6;
            animation: float 20s infinite ease-in-out;
        }
        .blob-1 { top: -10%; right: -10%; width: 500px; height: 500px; background: #ffe4e6; animation-delay: 0s; }
        .blob-2 { bottom: -20%; left: -20%; width: 400px; height: 400px; background: #fff1f2; animation-delay: -5s; }
        .blob-3 { top: 40%; left: 30%; width: 300px; height: 300px; background: #fff7ed; animation-delay: -10s; }

        @keyframes float {
            0% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
            100% { transform: translate(0, 0) scale(1); }
        }

        /* === 頂級毛玻璃特效 (Ultra Glassmorphism) === */
        .glass-panel {
            background: rgba(255, 255, 255, 0.65); /* 高透明度 */
            backdrop-filter: blur(16px) saturate(180%); /* 強烈模糊 + 飽和度提升 */
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8); /* 亮邊框 */
            box-shadow: 0 8px 32px 0 rgba(100, 100, 111, 0.05); /* 柔和陰影 */
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
            transition: all 0.3s ease;
        }
        .glass-card:hover {
            background: rgba(255, 255, 255, 0.8);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.06);
        }

        /* Banner */
        .banner-mask { height: 320px; clip-path: ellipse(170% 100% at 50% 0%); overflow: hidden; position: relative; }
        .banner-img { width: 100%; height: 100%; object-fit: cover; opacity: 0.95; transition: transform 10s ease; }
        .banner-mask:hover .banner-img { transform: scale(1.05); }

        .main-container { margin-top: -90px; position: relative; z-index: 20; padding-bottom: 120px; }

        /* 日期按鈕 */
        .active-day { 
            background: rgba(183, 40, 46, 0.85) !important; /* 茜色半透明 */
            backdrop-filter: blur(4px);
            color: white !important; 
            border: 1px solid rgba(255,255,255,0.2) !important;
            box-shadow: 0 8px 20px rgba(183, 40, 46, 0.25); 
            transform: scale(1.05);
        }

        /* 時間軸 */
        .timeline-line { position: absolute; left: 8px; top: 30px; bottom: -30px; width: 1px; background: rgba(0,0,0,0.05); z-index: 0; border-left: 1px dashed rgba(0,0,0,0.1); }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .action-btn { position: relative; z-index: 50; cursor: pointer !important; }
        .btn-press:active { transform: scale(0.92); }
        .text-shadow { text-shadow: 0 2px 8px rgba(0,0,0,0.4); }
        
        input, select, textarea {
            background: rgba(255,255,255,0.5);
            border: 1px solid rgba(0,0,0,0.05);
            transition: 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            background: rgba(255,255,255,0.9);
            border-color: #B7282E;
            outline: none;
        }

        [v-cloak] { display: none; }
        
        /* Modal Animation */
        .modal-enter-active, .modal-leave-active { transition: opacity 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }
        .modal-enter-active .modal-card, .modal-leave-active .modal-card { transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .modal-enter-from .modal-card, .modal-leave-to .modal-card { transform: scale(0.9) translateY(40px); }
    </style>
</head>
<body>

<div class="ambient-bg">
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
    <div class="blob blob-3"></div>
</div>

<div id="app" v-cloak>
    
    <div class="banner-mask shadow-2xl">
        <img src="banner.png" class="banner-img" alt="Kyoto" onerror="this.src='https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?auto=format&fit=crop&w=1000&q=80'">
        <div class="absolute inset-0 bg-gradient-to-b from-black/20 via-transparent to-black/60"></div>
        
        <div class="absolute top-14 left-6 z-10 pointer-events-none text-white">
            <p class="text-[10px] font-bold tracking-[0.4em] opacity-80 mb-1">OSAKA & KYOTO</p>
            <h1 class="text-5xl font-bold leading-none text-shadow font-serif">
                2025<br><span class="text-4xl font-normal">秋色漫旅</span>
            </h1>
        </div>
    </div>

    <main class="main-container px-4">
        
        <div v-if="currentTab === 'plan'" class="space-y-6">
            
            <div class="glass-panel rounded-[32px] p-5 flex items-center justify-between backdrop-blur-xl">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-white/50 flex items-center justify-center text-akane text-2xl shadow-sm">
                        <i :class="weather.icon"></i>
                    </div>
                    <div>
                        <div v-if="weather.loading" class="text-xs text-gray-400 font-medium">更新中...</div>
                        <div v-else-if="weather.hasData">
                            <div class="flex items-baseline gap-1">
                                <p class="text-3xl font-serif text-sumi font-bold">{{ weather.tempMax }}</p>
                                <span class="text-sm text-gray-500">°C</span>
                            </div>
                            <p class="text-[10px] text-gray-500 tracking-wide">降雨 {{ weather.rain }}mm</p>
                        </div>
                        <div v-else>
                            <p class="text-lg font-serif text-gray-400">尚無資料</p>
                            <p class="text-[10px] text-gray-400 tracking-wider">FUTURE DATE</p>
                        </div>
                    </div>
                </div>
                <div class="text-right">
                    <span class="text-[9px] bg-sumi text-white px-2 py-1 rounded-full tracking-widest opacity-80 mb-1 inline-block">
                        {{ weather.hasData ? 'HISTORY' : 'FORECAST' }}
                    </span>
                    <button @click="resetData" class="block text-[10px] text-gray-400 underline ml-auto hover:text-akane action-btn">重置</button>
                </div>
            </div>

            <div class="flex overflow-x-auto gap-3 pb-4 pt-2 no-scrollbar px-1">
                <button v-for="(day, index) in schedule" :key="index" @click="activeDay = index"
                    :class="['flex-shrink-0 w-16 h-20 rounded-2xl flex flex-col items-center justify-center transition-all glass-card action-btn', activeDay === index ? 'active-day' : 'text-gray-400']">
                    <span class="text-[10px] font-bold uppercase mb-1 tracking-wider opacity-80">{{ day.week }}</span>
                    <span class="text-lg font-serif font-bold">{{ day.date }}</span>
                </button>
            </div>

            <div class="space-y-5">
                <div v-for="(item, idx) in schedule[activeDay].items" :key="idx" class="relative pl-6 group">
                    <div class="timeline-line"></div>
                    
                    <div class="glass-card rounded-3xl p-5 relative overflow-hidden group">
                        <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-gradient-to-b from-akane to-orange-400 opacity-80"></div>
                        
                        <div class="flex justify-between items-start mb-3 relative z-30">
                            <div>
                                <span class="text-[10px] font-bold text-akane bg-red-50/50 px-2 py-0.5 rounded-lg border border-red-100 mb-2 inline-block">{{ item.tag }}</span>
                                <h3 class="font-serif font-bold text-lg text-sumi leading-tight">{{ item.title }}</h3>
                            </div>
                            
                            <div class="flex items-center gap-2 relative z-50">
                                <a v-if="item.mapUrl && item.mapUrl.trim() !== ''" :href="item.mapUrl" target="_blank" class="w-8 h-8 rounded-full bg-white/80 flex items-center justify-center text-blue-500 shadow-sm hover:bg-blue-500 hover:text-white transition-all action-btn" title="地圖">
                                    <i class="fa-solid fa-location-arrow text-xs"></i>
                                </a>
                                <button @click.stop="openEditModal(idx)" class="w-8 h-8 rounded-full bg-white/80 flex items-center justify-center text-gray-400 shadow-sm hover:bg-gray-800 hover:text-white transition-all action-btn">
                                    <i class="fa-solid fa-pen text-xs"></i>
                                </button>
                                <button @click.stop="deleteScheduleItem(idx)" class="w-8 h-8 rounded-full bg-white/80 flex items-center justify-center text-gray-300 shadow-sm hover:bg-akane hover:text-white transition-all action-btn">
                                    <i class="fa-solid fa-trash text-xs"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-2 text-sm text-gray-500 font-medium mb-2 relative z-10">
                            <i class="fa-regular fa-clock text-akane"></i> {{ item.time }}
                            <span v-if="item.transport" class="text-[10px] bg-gray-100/80 px-2 py-0.5 rounded text-gray-500 flex items-center gap-1">
                                <i :class="getTransportIcon(item.transportType)"></i> {{ item.transport }}
                            </span>
                        </div>
                        
                        <p class="text-sm text-gray-600 leading-relaxed relative z-10 whitespace-pre-wrap font-light tracking-wide" v-if="item.desc">{{ item.desc }}</p>
                    </div>
                </div>
                <div class="h-20"></div>
            </div>
            
            <button @click="openAddModal" class="fixed bottom-24 right-6 w-14 h-14 bg-sumi/90 backdrop-blur-md text-white rounded-full shadow-lg flex items-center justify-center text-xl z-50 btn-press action-btn border border-white/20">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>

        <div v-if="currentTab === 'info'" class="space-y-6 pb-24">
            <h2 class="text-2xl font-serif font-bold text-sumi border-l-4 border-akane pl-4">旅程資訊</h2>
            
            <div class="bg-sumi text-white p-6 rounded-[32px] shadow-xl relative overflow-hidden">
                <div class="absolute -right-10 -top-10 w-40 h-40 bg-white/10 rounded-full blur-3xl"></div>
                <p class="text-xs text-white/50 mb-2 font-bold tracking-widest uppercase">JPY Exchange Rate</p>
                <div class="flex items-center gap-4 relative z-10">
                    <input type="number" v-model="jpy" placeholder="0" class="bg-transparent text-4xl font-serif w-full outline-none border-b border-white/20 focus:border-akane text-white placeholder-white/20">
                    <i class="fa-solid fa-arrow-right text-white/30"></i>
                    <div class="text-right w-full">
                        <p class="text-sm text-white/50">TWD</p>
                        <p class="text-4xl font-serif">{{ jpy ? Math.round(jpy * 0.22).toLocaleString() : 0 }}</p>
                    </div>
                </div>
            </div>

            <div class="glass-panel rounded-3xl p-6">
                <h3 class="font-bold text-xs text-gray-400 uppercase mb-4 tracking-widest">Accommodation</h3>
                <div class="space-y-4">
                    <div v-for="h in hotels" class="relative pl-4 border-l-2 border-gray-200">
                        <span class="text-[10px] bg-gray-100 text-gray-600 px-2 py-0.5 rounded font-bold">{{ h.date }}</span>
                        <p class="font-bold text-gray-800 mt-1 font-serif">{{ h.name }}</p>
                        <a v-if="h.mapUrl" :href="h.mapUrl" target="_blank" class="text-xs text-blue-500 mt-2 inline-flex items-center gap-1 hover:underline action-btn">
                            <i class="fa-solid fa-map-pin"></i> 查看地圖
                        </a>
                    </div>
                </div>
            </div>

            <div class="glass-panel rounded-3xl p-6">
                <h3 class="font-bold text-xs text-gray-400 uppercase mb-4 tracking-widest">Backup & Sync</h3>
                <div class="flex gap-3">
                    <button @click="exportData" class="flex-1 bg-white/50 text-gray-600 py-3 rounded-xl text-xs font-bold border border-gray-200 action-btn hover:bg-white">
                        <i class="fa-solid fa-download mr-1"></i> 匯出
                    </button>
                    <button @click="triggerImport" class="flex-1 bg-sumi text-white py-3 rounded-xl text-xs font-bold action-btn hover:bg-gray-800 shadow-md">
                        <i class="fa-solid fa-upload mr-1"></i> 匯入
                    </button>
                    <input type="file" ref="fileInput" class="hidden" @change="importData" accept=".json">
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'shopping'" class="space-y-6 pb-24">
            <h2 class="text-2xl font-serif font-bold text-sumi border-l-4 border-akane pl-4">購物清單</h2>
            
            <div class="glass-panel p-2 rounded-2xl flex gap-2 sticky top-4 z-40">
                <input v-model="newShopItem" placeholder="想買什麼..." class="flex-1 bg-transparent px-4 py-3 text-sm font-medium" @keyup.enter="addShopItem">
                <button @click="addShopItem" class="w-12 h-12 bg-akane text-white rounded-xl flex-shrink-0 shadow-md btn-press action-btn">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <div class="space-y-3">
                <div v-for="(item, idx) in shoppingList" :key="idx" class="flex items-center justify-between p-4 glass-card rounded-2xl transition-all">
                    <div class="flex items-center gap-4 overflow-hidden flex-1 cursor-pointer action-btn" @click="item.done = !item.done">
                        <div :class="['w-5 h-5 rounded-full border-2 flex items-center justify-center transition-colors', item.done ? 'bg-akane border-akane' : 'border-gray-300']">
                            <i v-if="item.done" class="fa-solid fa-check text-white text-[10px]"></i>
                        </div>
                        <span :class="['font-medium truncate transition-colors', item.done ? 'line-through text-gray-300' : 'text-gray-700']">{{ item.name }}</span>
                    </div>
                    <button @click="removeShopItem(idx)" class="w-8 h-8 flex items-center justify-center text-gray-300 hover:text-akane transition-colors action-btn">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'wallet'" class="space-y-6 pb-24">
            <h2 class="text-2xl font-serif font-bold text-sumi border-l-4 border-akane pl-4">花費記帳</h2>
            
            <div class="bg-sumi text-white p-6 rounded-[32px] shadow-xl">
                <p class="text-xs text-white/50 mb-1 uppercase tracking-widest">Total Spent</p>
                <div class="flex items-baseline gap-1">
                    <span class="text-xl font-serif">¥</span>
                    <span class="text-5xl font-serif font-bold">{{ totalExpense.toLocaleString() }}</span>
                </div>
                <p class="text-xs text-white/30 mt-2">≈ NT$ {{ Math.round(totalExpense * 0.22).toLocaleString() }}</p>
            </div>

            <div class="glass-panel p-2 rounded-2xl flex gap-2">
                <input v-model="newExpenseName" placeholder="項目" class="flex-[2] bg-transparent px-4 py-3 text-sm font-medium">
                <input v-model="newExpensePrice" type="number" placeholder="¥" class="flex-1 bg-white/50 rounded-xl px-2 text-center text-sm font-bold">
                <button @click="addExpense" class="w-12 h-12 bg-sumi text-white rounded-xl flex-shrink-0 shadow-md btn-press action-btn">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <div class="space-y-3">
                <div v-for="(ex, idx) in expenses" :key="idx" class="flex justify-between items-center p-4 glass-card rounded-2xl">
                    <span class="font-bold text-gray-600 truncate mr-2">{{ ex.name }}</span>
                    <div class="flex items-center gap-3 flex-shrink-0">
                        <span class="font-bold font-serif text-sumi text-lg">¥ {{ parseInt(ex.price).toLocaleString() }}</span>
                        <button @click="removeExpense(idx)" class="text-gray-300 hover:text-akane text-xs action-btn"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="fixed bottom-6 left-6 right-6 h-16 glass-panel rounded-full flex items-center justify-around px-2 z-40">
        <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id"
            :class="['w-12 h-12 rounded-full flex items-center justify-center transition-all action-btn relative', currentTab === tab.id ? 'text-akane -translate-y-4 bg-white shadow-lg scale-110' : 'text-gray-400 hover:text-gray-600']">
            <i :class="[tab.icon, 'text-lg']"></i>
            <span v-if="currentTab === tab.id" class="absolute -bottom-6 text-[9px] font-bold tracking-widest text-akane uppercase">{{ tab.name }}</span>
        </button>
    </div>

    <transition name="modal">
        <div v-if="showModal" class="fixed inset-0 z-[100] flex items-end sm:items-center justify-center px-4 pb-4 sm:pb-0 pointer-events-none">
            <div class="absolute inset-0 bg-sumi/30 backdrop-blur-sm pointer-events-auto" @click="closeModal"></div>
            <div class="modal-card bg-white/90 backdrop-blur-xl w-full max-w-sm rounded-[32px] p-6 shadow-2xl relative z-10 pointer-events-auto border border-white">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-serif font-bold text-sumi">{{ isEditing ? '編輯行程' : '新增行程' }}</h3>
                    <button @click="closeModal" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500 action-btn hover:bg-gray-200"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-gray-400 uppercase ml-1">標題</label>
                        <input v-model="tempItem.title" placeholder="請輸入標題" class="w-full bg-white p-4 rounded-2xl shadow-sm text-lg font-bold text-sumi">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-400 uppercase ml-1">Google Maps 網址 (選填)</label>
                        <div class="relative">
                            <input v-model="tempItem.mapUrl" placeholder="http://..." class="w-full bg-white p-3 pl-8 rounded-xl shadow-sm text-sm text-blue-600">
                            <i class="fa-solid fa-link absolute left-3 top-3.5 text-gray-300"></i>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <div class="flex-1">
                            <label class="text-xs font-bold text-gray-400 uppercase ml-1">時間</label>
                            <input v-model="tempItem.time" type="time" class="w-full bg-white p-3 rounded-xl shadow-sm font-bold text-center">
                        </div>
                        <div class="flex-1">
                            <label class="text-xs font-bold text-gray-400 uppercase ml-1">分類</label>
                            <select v-model="tempItem.tag" class="w-full bg-white p-3 rounded-xl shadow-sm text-sm font-bold">
                                <option>景點</option><option>美食</option><option>購物</option>
                                <option>交通</option><option>住宿</option><option>攝影</option><option>自訂</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-400 uppercase ml-1">備註</label>
                        <textarea v-model="tempItem.desc" rows="3" placeholder="備註..." class="w-full bg-white p-3 rounded-xl shadow-sm text-sm resize-none"></textarea>
                    </div>
                </div>
                <button @click="saveSchedule" class="w-full bg-akane text-white font-bold py-4 rounded-2xl mt-6 shadow-lg btn-press action-btn">
                    {{ isEditing ? '儲存變更' : '確認新增' }}
                </button>
            </div>
        </div>
    </transition>
</div>

<script>
    const { createApp, ref, computed, watch, onMounted } = Vue;

    createApp({
        setup() {
            const currentTab = ref('plan');
            const activeDay = ref(0);
            const jpy = ref('');
            const fileInput = ref(null);
            const tripYear = ref('2025');
            const weather = ref({ loading: false, hasData: false, tempMax: '', rain: '', icon: 'fa-solid fa-cloud-sun' });

            const defaultSchedule = [
                {
                    week: 'Sun', date: '12/01',
                    items: [
                        { tag: '航班', title: '抵達大阪 (KIX)', time: '10:55', desc: 'BR182 抵達關西機場，出關後前往京都', transport: 'plane', transportType: 'plane' },
                        { tag: '交通', title: '前往京都', time: '13:00', desc: '搭乘 Haruka 特急 (約 75 分鐘)', transport: '1.5hr', transportType: 'train' },
                        { tag: '住宿', title: 'Check-in', time: '15:00', desc: 'HOTEL TAVINOS KYOTO 放行李', mapUrl: 'https://www.google.com/maps/search/?api=1&query=HOTEL+TAVINOS+KYOTO' },
                        { tag: '美食', title: '大力邸', time: '16:00', desc: '南禪寺附近 高級烏龍麵/和牛料理', mapUrl: 'https://www.google.com/maps/search/?api=1&query=Tairiki+Tei+Kyoto' },
                        { tag: '景點', title: '夜楓巡禮', time: '18:00', desc: '永觀堂、東寺夜間參拜', mapUrl: 'https://www.google.com/maps/search/?api=1&query=Eikando+Zenrinji+Kyoto' }
                    ]
                },
                { week: 'Mon', date: '12/02', items: [{ tag: '場勘', title: '京都巡禮', time: '09:00', desc: '路線：鴨川 → 花見小路 → 祇園白川 → 璃光和服 → 八阪神社', mapUrl: 'https://www.google.com/maps/search/?api=1&query=Hanamikoji+Street+Kyoto' }, { tag: '其他', title: '自由活動', time: '14:00', desc: '飲料販賣機考察、市區逛街' }] },
                { week: 'Tue', date: '12/03', items: [{ tag: '攝影', title: '全家福拍攝', time: '08:00', desc: '筱芷全家福開拍 (集合地點待定)' }] },
                { week: 'Wed', date: '12/04', items: [{ tag: '婚紗', title: '化妝', time: '05:15', desc: '飯店內造型開始 (至 08:15)' }, { tag: '婚紗', title: '南禪寺 (白紗)', time: '08:40', desc: '搭 Uber 前往，拍攝楓葉景', transport: 'Uber', transportType: 'car', mapUrl: 'https://www.google.com/maps/search/?api=1&query=Nanzenji+Temple' }, { tag: '婚紗', title: '移動換裝', time: '10:40', desc: '前往和服店' }, { tag: '婚紗', title: '二三年阪 (和服)', time: '12:30', desc: '日式街景拍攝', mapUrl: 'https://www.google.com/maps/search/?api=1&query=Sannenzaka+Kyoto' }] },
                { week: 'Thu', date: '12/05', items: [{ tag: '婚紗', title: '化妝', time: '05:00', desc: '飯店造型開始' }, { tag: '婚紗', title: '邊走邊拍 (白紗)', time: '08:00', desc: '鴨川、花見小路、祇園周邊', transport: 'Walk', transportType: 'walk' }, { tag: '婚紗', title: '換造型', time: '11:00', desc: '回飯店換裝' }, { tag: '婚紗', title: '真如堂 (黑紗)', time: '12:00', desc: '搭 Uber 前往拍攝', transport: 'Uber', transportType: 'car', mapUrl: 'https://www.google.com/maps/search/?api=1&query=Shinnyo-do+Temple' }] },
                { week: 'Fri', date: '12/06', items: [{ tag: '移動', title: '退房午餐', time: '10:00', desc: '京都車站用餐，購買 JR PASS' }, { tag: '交通', title: '前往西舞鶴', time: '12:25', desc: 'JR 列車 (抵達 13:54)', transport: 'Train', transportType: 'train' }, { tag: '交通', title: '青松號', time: '14:37', desc: '西舞鶴發車 → 天橋立 (15:18)', transportType: 'train' }, { tag: '景點', title: '天橋立沙洲', time: '15:30', desc: 'Check-in 後散步', mapUrl: 'https://www.google.com/maps/search/?api=1&query=Amanohashidate+View+Land' }, { tag: '美食', title: '富田屋', time: '18:00', desc: '晚餐、宮津市區漫步', mapUrl: 'https://www.google.com/maps/search/?api=1&query=Tondaya+Miyazu' }] },
                { week: 'Sat', date: '12/07', items: [{ tag: '景點', title: 'View Land', time: '09:00', desc: '搭乘纜車/吊椅上山看飛龍觀', mapUrl: 'https://www.google.com/maps/search/?api=1&query=Amanohashidate+View+Land' }, { tag: '美食', title: '松和物産 本店', time: '11:00', desc: '下山午餐', mapUrl: 'https://www.google.com/maps/search/?api=1&query=Showabussan+Amanohashidate' }, { tag: '交通', title: '前往伊根', time: '12:30', desc: '搭乘巴士 (約30-60分)', transport: 'Bus', transportType: 'bus' }, { tag: '景點', title: '伊根舟屋', time: '14:00', desc: 'Ine Cafe 下午茶、伊根浦公園', mapUrl: 'https://www.google.com/maps/search/?api=1&query=Ine+Cafe' }, { tag: '交通', title: '返回天橋立', time: '17:00', desc: '搭巴士回飯店', transportType: 'bus' }] },
                { week: 'Sun', date: '12/08', items: [{ tag: '交通', title: '返回大阪', time: '11:55', desc: '搭火車前往大阪 (14:23 抵達)', transport: 'Train', transportType: 'train' }, { tag: '住宿', title: '大阪東急卓越', time: '15:00', desc: 'Check-in', mapUrl: 'https://www.google.com/maps/search/?api=1&query=Osaka+Excel+Hotel+Tokyu' }, { tag: '景點', title: '道頓崛坐船', time: '16:00', desc: '驚安殿堂旁搭船 (20分鐘)', mapUrl: 'https://www.google.com/maps/search/?api=1&query=Dotonbori+Cruise' }, { tag: '景點', title: '摩天輪', time: '20:00', desc: '唐吉訶德摩天輪', mapUrl: 'https://www.google.com/maps/search/?api=1&query=Don+Quijote+Dotonbori+Ferris+Wheel' }, { tag: '美食', title: '螃蟹料理', time: '21:00', desc: '道頓崛周邊晚餐' }] },
                { week: 'Mon', date: '12/09', items: [{ tag: '景點', title: '環球影城', time: '08:30', desc: '抵達 USJ', transport: 'Train', transportType: 'train', mapUrl: 'https://www.google.com/maps/search/?api=1&query=Universal+Studios+Japan' }, { tag: '活動', title: 'VIP 導覽', time: '10:30', desc: '導覽開始，請準時集合' }] },
                { week: 'Tue', date: '12/10', items: [{ tag: '景點', title: '大阪市區', time: '10:00', desc: '通天閣溜滑梯', mapUrl: 'https://www.google.com/maps/search/?api=1&query=Tsutenkaku+Tower' }, { tag: '景點', title: '中崎町', time: '14:00', desc: '散步、下午茶', mapUrl: 'https://www.google.com/maps/search/?api=1&query=Nakazakicho' }, { tag: '美食', title: '浪芳庵', time: '16:00', desc: '日式點心', mapUrl: 'https://www.google.com/maps/search/?api=1&query=Namiyoshian' }] },
                { week: 'Wed', date: '12/11', items: [{ tag: '交通', title: '前往機場', time: '07:00', desc: '專車/巴士前往 KIX (1小時)', transport: 'Car', transportType: 'car' }, { tag: '航班', title: '返回高雄', time: '11:55', desc: 'EVA BR181 起飛 -> 14:30 抵達', transport: 'plane', transportType: 'plane' }] }
            ];

            const schedule = ref(JSON.parse(JSON.stringify(defaultSchedule)));
            const shoppingList = ref([]);
            const expenses = ref([]);

            const fetchWeather = async () => {
                weather.value.loading = true;
                const currentDay = schedule.value[activeDay.value];
                const dateStr = `${tripYear.value}-${currentDay.date.replace('/', '-')}`;
                const today = new Date().toISOString().split('T')[0];

                if (dateStr > today) {
                    weather.value = { loading: false, hasData: false, icon: 'fa-solid fa-cloud-sun' };
                    return;
                }

                try {
                    const lat = 34.69; const lon = 135.50; 
                    const url = `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=${dateStr}&end_date=${dateStr}&daily=temperature_2m_max,precipitation_sum&timezone=Asia%2FTokyo`;
                    
                    const res = await fetch(url);
                    const data = await res.json();

                    if (data.daily && data.daily.temperature_2m_max) {
                        const temp = data.daily.temperature_2m_max[0];
                        const rain = data.daily.precipitation_sum[0];
                        let icon = 'fa-solid fa-sun';
                        if (rain > 5) icon = 'fa-solid fa-cloud-showers-heavy';
                        else if (rain > 0) icon = 'fa-solid fa-cloud-rain';
                        else if (temp < 10) icon = 'fa-solid fa-snowflake';

                        weather.value = { loading: false, hasData: true, tempMax: temp, rain: rain, icon: icon };
                    } else {
                        weather.value = { loading: false, hasData: false, icon: 'fa-solid fa-cloud-sun' };
                    }
                } catch (e) {
                    weather.value = { loading: false, hasData: false, icon: 'fa-solid fa-cloud-sun' };
                }
            };

            watch(activeDay, () => fetchWeather());
            onMounted(() => {
                const savedSch = localStorage.getItem('trip_v10_sch');
                if (savedSch) schedule.value = JSON.parse(savedSch);
                const savedShop = localStorage.getItem('trip_v10_shop');
                if (savedShop) shoppingList.value = JSON.parse(savedShop);
                const savedExp = localStorage.getItem('trip_v10_exp');
                if (savedExp) expenses.value = JSON.parse(savedExp);
                
                fetchWeather(); 
            });

            watch(schedule, v => localStorage.setItem('trip_v10_sch', JSON.stringify(v)), { deep: true });
            watch(shoppingList, v => localStorage.setItem('trip_v10_shop', JSON.stringify(v)), { deep: true });
            watch(expenses, v => localStorage.setItem('trip_v10_exp', JSON.stringify(v)), { deep: true });

            const newShopItem = ref('');
            const addShopItem = () => { if(newShopItem.value.trim()) { shoppingList.value.push({ name: newShopItem.value, done: false }); newShopItem.value = ''; } };
            const removeShopItem = (idx) => shoppingList.value.splice(idx, 1);

            const newExpenseName = ref('');
            const newExpensePrice = ref('');
            const addExpense = () => { if(newExpenseName.value.trim() && newExpensePrice.value) { expenses.value.unshift({ name: newExpenseName.value, price: newExpensePrice.value }); newExpenseName.value = ''; newExpensePrice.value = ''; } };
            const removeExpense = (idx) => expenses.value.splice(idx, 1);
            const totalExpense = computed(() => expenses.value.reduce((acc, cur) => acc + parseInt(cur.price || 0), 0));

            const showModal = ref(false);
            const isEditing = ref(false);
            const editingIndex = ref(-1);
            const tempItem = ref({ title: '', time: '', tag: '自訂', desc: '', mapUrl: '' });

            const openAddModal = () => {
                isEditing.value = false;
                tempItem.value = { title: '', time: '', tag: '自訂', desc: '', mapUrl: '' };
                showModal.value = true;
            };
            const openEditModal = (idx) => {
                isEditing.value = true;
                editingIndex.value = idx;
                const item = schedule.value[activeDay.value].items[idx];
                tempItem.value = { ...item, mapUrl: item.mapUrl || '' };
                showModal.value = true;
            };
            const closeModal = () => showModal.value = false;
            const saveSchedule = () => {
                if (!tempItem.value.title) return;
                const itemData = { ...tempItem.value, time: tempItem.value.time || '待定' };
                if (isEditing.value) {
                    schedule.value[activeDay.value].items[editingIndex.value] = itemData;
                } else {
                    schedule.value[activeDay.value].items.push(itemData);
                }
                closeModal();
            };
            const deleteScheduleItem = (idx) => {
                if (confirm('確定要刪除嗎？')) schedule.value[activeDay.value].items.splice(idx, 1);
            };

            const resetData = () => {
                if (confirm('確定重置？這會清除所有自訂資料。')) {
                    localStorage.clear();
                    location.reload();
                }
            };

            const exportData = () => {
                const data = { schedule: schedule.value, shoppingList: shoppingList.value, expenses: expenses.value };
                const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `大阪自由行備份.json`;
                a.click();
            };
            const triggerImport = () => fileInput.value.click();
            const importData = (e) => {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const data = JSON.parse(evt.target.result);
                        if(data.schedule) schedule.value = data.schedule;
                        if(data.shoppingList) shoppingList.value = data.shoppingList;
                        if(data.expenses) expenses.value = data.expenses;
                        alert('匯入成功！');
                    } catch(err) { alert('檔案錯誤'); }
                };
                reader.readAsText(e.target.files[0]);
            };

            const tabs = [
                { id: 'plan', name: '行程', icon: 'fa-solid fa-map' },
                { id: 'info', name: '資訊', icon: 'fa-solid fa-circle-info' },
                { id: 'shopping', name: '購物', icon: 'fa-solid fa-bag-shopping' },
                { id: 'wallet', name: '錢包', icon: 'fa-solid fa-wallet' }
            ];
            const hotels = [
                { date: '12/1-12/5', name: 'HOTEL TAVINOS KYOTO', mapUrl: 'https://www.google.com/maps/search/?api=1&query=HOTEL+TAVINOS+KYOTO' }, 
                { date: '12/6-12/7', name: 'Fairfield by Marriott Amanohashidate', mapUrl: 'https://www.google.com/maps/search/?api=1&query=Fairfield+by+Marriott+Kyoto+Amanohashidate' }, 
                { date: '12/8-12/10', name: '大阪東急卓越大酒店', mapUrl: 'https://www.google.com/maps/search/?api=1&query=Osaka+Excel+Hotel+Tokyu' }
            ];
            const getTransportIcon = (t) => ({ plane: 'fa-solid fa-plane', train: 'fa-solid fa-train-subway', bus: 'fa-solid fa-bus', car: 'fa-solid fa-car', walk: 'fa-solid fa-person-walking' }[t] || 'fa-solid fa-location-arrow');

            return { 
                currentTab, activeDay, jpy, tabs, schedule, hotels, getTransportIcon, 
                newShopItem, shoppingList, addShopItem, removeShopItem, 
                newExpenseName, newExpensePrice, expenses, addExpense, removeExpense, totalExpense,
                showModal, tempItem, openAddModal, openEditModal, closeModal, saveSchedule, deleteScheduleItem, isEditing,
                exportData, importData, triggerImport, fileInput, resetData, weather
            };
        }
    }).mount('#app');
</script>
</body>
</html>
